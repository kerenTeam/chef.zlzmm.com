define("module/captcha/CaptchaLogicBase",[],function(){return BaseClass.extend({_lastCaptcha:"",_status:!1,checkCaptcha:function(){var e=this;this.trigger("beforeCheck");var t=this.getCaptcha(),n=this.getPhone();""!=t?this.postCaptchaCheck(n,t,function(t){e._captchaRight({response:t})},function(t){e._captchaWrong({response:t})}):this._status?this._captchaRight({}):this._captchaWrong({}),this._lastCaptcha=t,this.trigger("afterCheck")},sendSms:function(){var e=this.getPhone();this.clear(),/1\d{10}/.test(e)&&(this.postSmsSend(e),this.trigger("afterSendSms"))},sendVoice:function(){var e=this.getPhone();this.clear(),/1\d{10}/.test(e)&&(this.postVoiceSend(e),this.trigger("afterSendVoice"))},isVerified:function(){return 1==this._status},clear:function(){this._status=!1,this._lastCaptcha="",this.setCaptcha(""),this.trigger("clear")},_captchaRight:function(e){this._status=!0,this.trigger("captchaRight",e)},_captchaWrong:function(e){this._status=!1,this.trigger("captchaWrong",e)},postCaptchaCheck:function(){},postSmsSend:function(){},postVoiceSend:function(){},getCaptcha:function(){return""},setCaptcha:function(){},getPhone:function(){return""}})}),define("fe_common/module/dialog/simpledialog",[],function(){var e=BaseClass.extend({_content:"",_width:null,_height:null,_fixed:!1,_id:null,_classes:"simpledialog",_showOnBuild:!0,_$wrapper:null,_$content:null,_$mask:null,_autoPosition:!0,init:function(e){this._content=e.content,this._width=e.width,this._height=e.height,this._fixed=e.fixed||!1,this._id=e.id||"dialog"+(new Date).valueOf(),this._classes=e.class||"simpledialog",this._showOnBuild=null!=e.show?e.show:!0,this._$wrapper=$('<div id="'+this._id+'" class="'+this._classes+'" style="display:none;"></div>'),this._$content=$(this._content),this._$mask=e.mask===!1?null:$('<div class="mask" style="display:none"></div>'),this._autoPosition=e.autoPosition!==!1,this._build(),this._showOnBuild&&this.show()},_build:function(){this._updateContent();var e={};null!=this._width&&(e.width=this._width+"px"),null!=this._height&&(e.height=this._height+"px"),this._fixed&&(e.position="fixed");for(var t in e){this._$wrapper.css(e);break}this._$wrapper.appendTo("body"),this._$mask&&this._$mask.appendTo("body")},_updateContent:function(){this._$wrapper.empty().append(this._$content)},getJElem:function(){return this._$wrapper},getJContent:function(){return this._$content},show:function(){this.trigger("show"),this._$wrapper.show(),this._autoPosition&&this.adjust(),this._$mask&&this._$mask.show(),this.trigger("showed")},hide:function(){this.trigger("hide"),this._$wrapper.hide(),this._$mask&&this._$mask.hide(),this.trigger("hided")},close:function(){this.trigger("close"),this._$wrapper.remove(),this._$mask&&this._$mask.remove(),this.trigger("closed")},setContent:function(e){this._content=e,this._$content=$(this._content),this._updateContent()},adjust:function(){var e=this._$wrapper.height(),t=this._$wrapper.width(),n=$(window),r=n.height(),i=n.width(),s=(r-e)/2+document.body.scrollTop,o=(i-t)/2;this._$wrapper.css({top:s+"px",left:o+"px"})}});return e}),define("fe_common/module/dialog/commondialog",["fe_common/module/dialog/simpledialog"],function(e){var t=e.extend({_hideOnClose:!1,init:function(e){this._hideOnClose=e.hideOnClose||!1;var t=this,n=$('<div class="commondialog-close"><i class="icon-crossregu"></i></div>');e.content=n.add(e.content),this._super(e),n.click(function(){t._hideOnClose?t.hide():t.close()})}});return t}),define("fe_common/module/StatusButton",[],function(){var e=function(e){var t=$(e),n=0;return t.enable=function(){return n=0,t.removeAttr("disabled").removeClass("btn-invalid")},t.disable=function(){return n=1,t.attr("disabled","disabled").addClass("btn-invalid")},t};return e}),define("module/captcha/CountDownButton",["fe_common/module/StatusButton"],function(e){return BaseClass.extend({_statusBtn:null,_normalWord:"",_countDownWord:"",_interval:60,_timer:null,init:function(n){this._interval=n.interval||60,this._statusBtn=new e(n.jQbtn),this._normalWord=this._statusBtn.text(),this._countDownWord=this._statusBtn.data("countdown-word")||"({#}s)閲嶆柊鑾峰彇"},beginCountDown:function(){var e=this,t=this._interval,n=this._statusBtn;n.disable().text(e._countDownWord.replace("{#}",t)),this._timer&&this.endCountDown(),e.trigger("beginCountDown"),this._timer=setInterval(function(){--t<=0?e.endCountDown():n.text(e._countDownWord.replace("{#}",t))},1e3)},endCountDown:function(){this._timer&&(clearInterval(this._timer),this._timer=null,this._statusBtn.enable().text(this._normalWord),this.trigger("endCountDown"))},getJElement:function(){return this._statusBtn}})}),define("module/captcha/CaptchaDialog",["fe_common/module/dialog/commondialog","module/captcha/CountDownButton","fe_common/module/StatusButton"],function(e,t,n){return e.extend({_submitBtn:null,_type:"sms",_canVoice:!1,_userPhone:null,_jQwrap:null,_jQtip:null,_jQvoiceSendLink:null,_jQcaptchaInput:null,_jQsendBtn:null,_jQrightIcon:null,_jQwrongIcon:null,_countDownBtn:null,_captchaLogic:null,_tpl:null,_interval:60,init:function(e){this._type=e.type||this._type,this._canVoice=e.canVoice||this._canVoice,this._userPhone=e.userPhone,this._captchaLogic=e.captchaLogic,this._tpl=e.tpl,this._interval=e.interval||this._interval,this._super({content:this.getHtml()});var r=this._jQwrap=this.getJContent();this._jQtip=r.find(".j-phoneverifier-dialingtip"),this._jQvoiceSendLink="sms"==this._type?r.find(".j-voice"):null,this._submitBtn=new n(r.find(".j-submit")),this._jQcaptchaInput=r.find(".j-captcha-input"),this._jQsendBtn=r.find(".j-captcha-sendbtn"),this._jQrightIcon=r.find(".j-captcha-rightico"),this._jQwrongIcon=r.find(".j-captcha-wrongico"),this._countDownBtn=new t({jQbtn:this._jQsendBtn,interval:this._interval}),this._initCaptchaLogic(),this._initSendBtn(),this._initEvents()},_initCaptchaLogic:function(){var e=this,t=this._captchaLogic;t.getCaptcha=function(){return e._jQcaptchaInput.val()},t.setCaptcha=function(t){return e._jQcaptchaInput.val(t)},t.getPhone=function(){return e._userPhone},t.on("beforeCheck",function(){e._clear()}),t.on("afterSendSms",function(){e._clear()}),t.on("afterSendVoice",function(){e._clear()}),t.on("captchaRight",function(){e._jQrightIcon.show(),e._jQwrongIcon.hide()}),t.on("captchaWrong",function(){e._jQrightIcon.hide(),e._jQwrongIcon.show()})},_initSendBtn:function(){var e=this;this._jQsendBtn.click(function(){"voice"==e._type?e._captchaLogic.sendVoice():"sms"==e._type&&e._captchaLogic.sendSms()}),"voice"==this._type?this._captchaLogic.on("afterSendVoice",function(){e._countDownBtn.beginCountDown()}):"sms"==this._type&&this._captchaLogic.on("afterSendSms",function(){e._countDownBtn.beginCountDown()})},_clear:function(){this._jQrightIcon.hide(),this._jQwrongIcon.hide()},_initEvents:function(){var e=this,t=this._submitBtn,n=this._jQvoiceSendLink;t.click(function(){t.disable(),e.trigger("submit")}),n&&n.click($.proxy(this._clickVoiceSendLink,this))},enableSubmit:function(){this._submitBtn.enable()},voiceSentSuccess:function(e){var t=this;this._jQtip.show().find(".j-server").text(e),setTimeout(function(){t._jQtip.hide(),t._enableVoiceSendLink()},1e3*t._interval)},getHtml:function(){return this._tpl.getHtml()},_clickVoiceSendLink:function(){this._jQvoiceSendLink.hasClass("phoneverifier-voice-disable")||(this._disableVoiceSendLink(),this._captchaLogic.sendVoice())},_disableVoiceSendLink:function(){this._jQvoiceSendLink&&this._jQvoiceSendLink.addClass("phoneverifier-voice-disable")},_enableVoiceSendLink:function(){this._jQvoiceSendLink&&this._jQvoiceSendLink.removeClass("phoneverifier-voice-disable")}})}),define("module/captcha/CaptchaDialogTpl",[],function(){return BaseClass.extend({_submitText:"鎻愪氦璁㈠崟",_desc:"涓轰繚璇侀€侀鍛樿兘鑱旂郴鍒版偍锛岃楠岃瘉鎮ㄧ殑鎵嬫満鍙风爜",_canVoice:!0,_type:"sms",init:function(e,t,n){n&&(this._submitText=n.submitText||this._submitText,this._desc=n.desc||this._desc),this._type=e,this._canVoice=t},getHtml:function(){var e="voice"==this._type?'<button class="combtn phoneverifier-codesend j-captcha-sendbtn" data-countdown-word="({#}s)閲嶆柊鎺ュ惉">鎺ュ惉璇煶楠岃瘉鐮�</button>':'<button class="combtn phoneverifier-codesend j-captcha-sendbtn">鑾峰彇楠岃瘉鐮�</button>',t="";"sms"==this._type&&this._canVoice&&(t='<p class="phoneverifier-sub">鏀朵笉鍒扮煭淇★紵浣跨敤<a class="phoneverifier-voice j-voice" href="javascript:;">璇煶楠岃瘉鐮�</a></p>');var n='<div class="commondialog-content phoneverifier"><h3 class="phoneverifier-title">鎵嬫満鍙风爜楠岃瘉</h3><p class="phoneverifier-desc">'+this._desc+'</p><div class="phoneverifier-codewrap"> <input class="phoneverifier-codeinput j-captcha-input" placeholder="璇疯緭鍏ラ獙璇佺爜"> <i class="j-captcha-rightico icon i-rightgreen" style="display: none"></i> <i class="j-captcha-wrongico icon i-wrongred" style="display: none"></i>'+e+'</div><button class="combtn phoneverifier-btn j-submit">'+this._submitText+"</button>"+t+'<p class="j-phoneverifier-dialingtip phoneverifier-dialingtip" style="display:none;">鐢佃瘽鎷ㄦ墦涓�...<br>璇风暀鎰忔潵鑷�<em class="j-server"></em>鐨勭數璇�</p><p class="phoneverifier-protocol"><i><em></em></i>宸插悓鎰忋€�<a target="_blank" href="http://i.meituan.com/about/terms">缇庡洟缃戠敤鎴峰崗璁�</a>銆�</p></div>';return n}})}),define("fe_common/module/dialog/buttondialog",["fe_common/module/dialog/simpledialog"],function(e){var t=e.extend({_btns:[],_$wordWrap:null,_$contentWrap:null,init:function(e){var t=this,n=e.btns;this._$wordWrap=$('<div class="buttondialog-word"></div>').append(e.content),this._$contentWrap=$('<div class="buttondialog-wrap"></div>');for(var r=$('<div class="buttondialog-op"></div>'),i=0,s=n.length;s>i;i++){var o=n[i].func,u=n[i].attrs,a=[];if(u)for(var f in u)a.push(f+'="'+u[f]+'"');var l=$("<button "+a.join(" ")+">"+n[i].value+"</button>");l.__clickFunc=o,t._btns.push(l),r.append(l)}this._$contentWrap.append(this._$wordWrap).append(r),e=$.extend(e,{content:this._$contentWrap}),this._super(e);for(var i=0,s=this._btns.length;s>i;i++){var c=this._btns[i];!function(e){c.click(function(){e.call(this)})}(c.__clickFunc)}}});return t.alert=function(e,n){var r=new t({content:e,btns:[{value:"纭",func:function(){r.close(),"function"==typeof n&&n()}}]})},t.confirm=function(e,n){var r=new t({content:e,btns:[{value:"纭",func:function(){r.close(),"function"==typeof n&&n()}},{value:"鍙栨秷",func:function(){r.close()}}]})},t}),define("fe_common/module/ComSelect",[],function(){var e=Class.extend({_jQwrap:null,_jQselect:null,_jQvalue:null,_showSelectedText:function(){var e=this._jQselect.find("option").filter(function(){return this.selected}),t=e.attr("value"),n=e.html();this._jQvalue.html(n),-1==t?this._jQvalue.addClass("comselect-unselected"):this._jQvalue.removeClass("comselect-unselected")},init:function(e){var t=this;this._jQwrap=$(e),this._jQselect=this._jQwrap.find(".j-comselect-select"),this._jQvalue=this._jQwrap.find(".j-select-value"),this._jQselect.change(function(){t._showSelectedText()}).change()},val:function(e){if(null==e){var e=this._jQselect.val();return e}this._jQselect.val(e).change()},find:function(e){return this._jQwrap.find(e)}});return e}),define("fe_common/module/storeroom",[],function(){var e=BaseClass.extend({_type:null,_verifyCode:null,_store:null,_items:null,id:null,init:function(e,t,n){this._items={},this.id=e,this._type=n,this._verifyCode=null==t?"_":t,this._store=$wm.StoreFactory.getStore(n)},register:function(e){this._items[e.name]=e},backup:function(){var e={};for(var t in this._items){var n=this._items[t].backup();if(null!=n&&("function"==typeof n||"object"==typeof n))throw new Error("type "+typeof n+" is not support");e[t]=n}var r=JSON.stringify(e);r=this._verifyCode+"|"+r,this._store.setItem(this.id,r)},restore:function(){var e=this._verifyCode+"|",t=this._store.getItem(this.id);if(null!=t&&0==t.indexOf(e)){var n=JSON.parse(t.replace(e,""));for(var r in this._items){var i=n[r];null!=i&&this._items[r].restore(i)}}},clear:function(){this._store.removeItem(this.id)}}),t={newStore:function(t,n,r){return new e(t,n,r)}};return t}),define("module/FoodStore",[],function(){var e=BaseClass.extend({orders:{},poi:null,_store:null,init:function(){this._store=$wm.store,this._read()},save:function(e,t){var n=[];for(var r in t){var i=parseInt(t[r].num);i>0&&(n.push(r),n.push(","),n.push(i),n.push("|"))}var s=e+":"+n.join("");this._store.setItem("w_c",s)},clear:function(){this._store.removeItem("w_c")},_read:function(){var e=this._store.getItem("w_c");if(null!=e){var t=e.indexOf(":"),n=e.substring(0,t),r=e.substring(t+1);if(n=parseInt(n),n>=0){for(var i=r.split("|"),s=0,o=i.length;o>s;s++){var u=i[s].split(",");if(2==u.length){var a=parseInt(u[1]),f=u[0],l=parseInt(f.split("-")[0]),c=parseInt(f.split("-")[1]);a>0&&l>0&&c>0&&(this.orders[f]={num:a})}}this.poi=n}}}});return e}),define("fe_common/module/dialog/tipdialog",["fe_common/module/dialog/simpledialog"],function(e){var t=e.extend({_type:null,_hideDelay:2e3,_animationTime:300,init:function(e){e=e||{},this._type=e.type?e.type:this._type,this._hideDelay="number"==typeof e.hideDelay?e.hideDelay:this._hideDelay,this._showOnce="boolean"==typeof e.showOnce?e.showOnce:!1,e=$.extend({mask:!1,"class":"tipdialog"},e),e.content=this._getContent(e.content),this._super(e)},_getContent:function(e){var t='<div class="tipdialog-content">';switch(this._type){case"success":t+='<i class="icon-tick"></i>';break;case"fail":t+='<i class="icon-cross"></i>'}return t+="<span>"+e+"</span></div>"},show:function(){var e=this;this._super(),this._$wrapper.css("opacity","1"),this._showOnce&&this.on("hided",function(){e.close()}),0!=this._hideDelay&&setTimeout(function(){e.hide()},this._hideDelay)},hide:function(){var e=this;this.trigger("hide"),this._$wrapper.css("opacity","0"),this._$mask&&this._$mask.hide(),setTimeout(function(){e._$wrapper.hide(),e.trigger("hided")},this._animationTime)}});return t}),define("fe_common/module/template",[],function(){var e={},t={};window.__templateEncodeHtml=function(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e},function(e){for(var n=e.length;n--;)t[e[n]]=!0}("break,case,catch,continue,debugger,default,delete,do,else,false,finally,for,function,if,in,instanceof,new,null,return,switch,this,throw,true,try,typeof,var,void,while,with,abstract,boolean,byte,char,class,const,double,enum,export,extends,final,float,goto,implements,import,int,interface,long,native,package,private,protected,public,short,static,super,synchronized,throws,transient,volatile,arguments,let,yield".split(","));var n=function(e){return t[e]};return function(t,r,i){var i=i||{},s=0!=i.xssSafe;if(e[t])return r?e[t](r):e[t];t=t.replace(/\/\*.*?\*\/|\/\/.*?[\n\r\t]/g,"").replace(/[\r\t\n]/g," ");var o={},u="var ",a=t.match(/<%(.*?)%>/g).join(",").match(/[\_\$a-zA-Z]+[0-9]*/g);!function(e){for(var t=e.length,r="";t--;)r=e[t],r&&!n(r)&&(o.hasOwnProperty(r)||(u+=r+"= __data."+r+",",o[r]=!0))}(a);var f=e[t]=new Function("__data",u+"__s=''; __s += '"+t.replace(/<%=(.*?)%>/g,function(e,t){return"'+"+(s&&t.lastIndexOf("_noescape")!=t.length-9?"__templateEncodeHtml("+t+")":"("+t+")")+"+'"}).replace(/%>[\s]*<%/g,"").replace(/<%/g,"';").replace(/%>/g,"__s += '")+"';return __s;");return r?f(r):f}}),define("module/payOnlineD",[],function(){var e=function(e){var t={token:$.cookie("lt"),tradeno:e.tradeno,pay_token:e.pay_token,nb_platform:"touch",nb_version:"1.0",pay_success_url:e.pay_success_url,redr_url:e.redr_url},n=$("<form/>");n.attr({action:e.pay_url,method:"post",target:"_self"});for(var r in t)n.append('<input type="hidden" name="'+r+'" value="'+t[r]+'">');return n.submit(),!1};return e}),define("module/payTest",["fe_common/module/dialog/buttondialog"],function(e){var t=function(t,r){var i=new e({content:"鏀粯娴嬭瘯",btns:[{value:"鏀粯",func:function(){$.post(t+"/pay/testOnlinePay/"+r,function(){i.close(),delayGo(t+"/order/statusdetail/"+r)})}},{value:"鍙栨秷",func:function(){i.close(),delayGo(t+"/order/statusdetail/"+r)}}]})};return t}),define("page/order/SmsCaptcha",["module/captcha/CaptchaLogicBase","module/captcha/CaptchaDialog","module/captcha/CaptchaDialogTpl"],function(e,t,n){var r=BaseClass.extend({_dlg:null,_captchaObj:null,init:function(r){var i=r.baseurl,s=r.isLogin,o=r.type||"sms",u=r.onSubmit,a=this,f,l=$(".addr-phone").text(),c=this._captchaObj=new e;c.postCaptchaCheck=function(e,t,n,s){$.post(i+"/order/ajax/validate",{phone:e,token:r.token,verify_code:t,login_token:r.logintoken},function(e){e&&(e.code==0?n(e):s(e))})},c.postSmsSend=function(e){$.post(i+"/order/ajax/getvalidatecode",{validate_type:1,phone:e,login_token:r.token,token:r.token})},c.postVoiceSend=function(e){$.post(i+"/order/ajax/getvalidatecode",{validate_type:o=="voice"?3:2,phone:e,login_token:r.token,token:r.token},function(e){e.code==0&&f.voiceSentSuccess(e.data.feedback_call)})},c.on("captchaRight",function(){u()}),c.on("captchaWrong",function(e){f.enableSubmit()});var h=$(".addr-phone").text();f=this._dlg=new t({type:o,canVoice:r.canVoice,userPhone:l,captchaLogic:this._captchaObj,tpl:new n(o,r.canVoice,{submitText:"鎻愪氦璁㈠崟",desc:'涓轰繚璇侀€侀鍛樿兘鑱旂郴鍒版偍锛岃楠岃瘉<span style="color: #ffd603;">'+h+"</span>"})}),o=="sms"&&this._captchaObj.sendSms(),f.on("submit",function(){a.checkCaptcha()}),f.on("close",function(){a.destroy(!0)})},isVerified:function(){return this._captchaObj.isVerified()},getCaptcha:function(){return this._captchaObj.getCaptcha()},checkCaptcha:function(){return this._captchaObj.checkCaptcha()},destroy:function(e){this._dlg!=null&&(e||this._dlg.close(),this._dlg=null),this.trigger("destroy")}});return r}),define("page/order/orderTip",[],function(){var e={_jQwrap:null,_jQcontentWrap:null,init:function(){var e=this;this._jQwrap=$("#order-tip"),this._jQcontentWrap=this._jQwrap.find(".j-order-tip-height"),this._jQwrap.find(".j-order-tip-close").click($.proxy(this.hide,this))},show:function(e){e!=null&&e.length>0&&this._jQcontentWrap.text(e),this._jQwrap.show()},hide:function(){this._jQwrap.hide()}};return e.init(),e}),define("page/order/order",["page/order/SmsCaptcha","fe_common/module/dialog/buttondialog","fe_common/module/ComSelect","fe_common/module/storeroom","module/FoodStore","fe_common/module/dialog/tipdialog","fe_common/module/dialog/commondialog","fe_common/module/template","page/order/orderTip","fe_common/module/dialog/simpledialog","module/payOnlineD","module/payTest"],function(e,t,n,r,i,s,o,u,a,f,l,c){return{environment:"",baseurl:"",_logintoken:"",smsCaptcha:null,orderData:null,_receiveTime:"",_store:null,_foodStore:null,_foodlist:null,_token:"",_inited:!1,_supportAssignDeliveryTime:!1,btn:{_$component:$("#order-submit"),_status:0,enable:function(){this._status=0,this._$component.removeAttr("disabled").removeClass("btn-invalid").val("绔嬪嵆涓嬪崟")},disable:function(){this._status=1,this._$component.attr("disabled","disabled").addClass("btn-invalid").val("鎻愪氦涓�")},reactive:function(){this._status==1&&(this._status=0,this._$component.removeAttr("disabled").removeClass("btn-invalid").val("绔嬪嵆涓嬪崟"))}},submit_order:function(){var e=this,t=e.orderData,n=t.address_type;if(n!=1)return new s({content:"璇疯緭鍏ユ敹璐у湴鍧€"}),!1;if($(".order-timefield-txt").text()=="鏈€夋嫨")return new s({content:"璇烽€夋嫨閫佽揪鏃堕棿"}),!1;var r={recipient_name:addressInfo.name,recipient_gender:addressInfo.gender,recipient_address:addressInfo.address,house_number:addressInfo.house_number,recipient_phone:addressInfo.phone,addr_latitude:addressInfo.latitude,addr_longitude:addressInfo.longitude,expected_arrival_time:e._receiveTime?e._receiveTime:0};e.btn.disable(),e._submitPost(r)},_submitPost:function(n){var r=this,i=$("#user_caution").val().replace(/(\ud83c[\udf00-\udfff])|(\ud83d[\udc00-\ude4f])|(\ud83d[\ude80-\udeff])/g,"");n=$.extend(n,{wm_poi_id:r._foodStore.poi,foodlist:r._foodlist,caution:i,token:r._token,info:{code:20000012},login_token:r._logintoken,wm_order_pay_type:this._payType,poi_discount_coupon_id:$("#poi-coupon-info").data("couponid"),csrf_token:r.csrfToken,check_shipping_area:1}),this.smsCaptcha&&this.smsCaptcha.isVerified()&&(n.sms_code=this.smsCaptcha.getCaptcha());var o=!1,u=function(){$.ajax({url:r.baseurl+"/order/ajax/submit",data:{data:JSON.stringify(n)},type:"post",dataType:"json",success:function(n){r.smsCaptcha!=null&&r.smsCaptcha.destroy();if(0==n["code"]){r._clear(),$wm.store.removeItem("w_payType"),$wm.store.removeItem("poiDiscountCouponId"),$wm.store.removeItem("currentAddr");var i=n.data;i.wm_order_pay_type==1?delayGo(r.baseurl+"/order/statusdetail/"+i.hash_id):r.environment=="test"||r.environment=="qatest"?c(r.baseurl,i.hash_id):l(i)}else if(200401==n["code"]||10==n["code"])$wm.store.setItem("wm_unlogin",!0),r._store.backup(),delayGo("http://"+(r.environment=="test"?"192.168.4.67:8080":"i.meituan.com")+"/account/login?backurl="+location.href);else if(5==n["code"]){var s=$(".addr-phone").text();$.post(r.baseurl+"/order/ajax/getvalidatetype",{phone:s,token:r._token},function(t){if(t){var n=t.data.ways;r.smsCaptcha=new e({baseurl:r.baseurl,isLogin:!0,onSubmit:$.proxy(r.submit_order,r),type:n==3?"voice":"sms",canVoice:n==1?!0:!1,token:r._token,logintoken:r._logintoken}),r.smsCaptcha._dlg.on("close",function(){r.btn.reactive()})}})}else if(13==n["code"])var o=new t({content:"鏀惰揣鍦板潃涓嶅湪閰嶉€佽寖鍥村唴锛屾棤娉曚笅鍗�",btns:[{value:"淇敼鍦板潃",func:function(){$(".address-field").click(),o.close()}},{value:"鍙栨秷",func:function(){o.close()}}]});else t.alert(n.msg||"涓嬪崟澶辫触锛屽叧闂〉闈㈠啀鏉ヤ竴娆�"),$wm.log.error("[Order Fail] "+JSON.stringify(n)),delayGo(function(){history.go(-1)})},error:function(e){if(e.status==420&&e.statusText=="CSRF-TOKEN")return new s({content:"璇锋眰csrf_token閿欒锛岃鍒锋柊椤甸潰閲嶈瘯鎴栬嚧鐢靛鏈嶏紒"}),!1}})};setTimeout(function(){o||(n.fingerPrint="",u())},200)},init:function(e){var t=this;t.environment=e.environment,t.baseurl=e.baseurl,t.csrfToken=e.csrfToken,t.order=e.order,t._logintoken=$.cookie("lt")||"",t._payType=1;var n=$wm.store.getItem("v_order_hash");n||(n=Number(Math.round((new Date).getTime())).toString(16),$wm.store.setItem("v_order_hash",n)),this._store=r.newStore("v_order_cache",n,"sessionStorage"),this._foodStore=new i,$(".j-back-link").on("click",function(){return document.referrer?document.referrer.indexOf("/user/getaddr")>-1||document.referrer.indexOf("/user/editaddr")>-1||document.referrer.indexOf("/order/poicoupons")>-1?delayGo(t.baseurl+"/restaurant/"+t._foodStore.poi):delayGo(function(){history.go(-1)}):delayGo(function(){history.go(-2)}),!1}),this._updateOrderData(function(){t._initPayType(),t._initPreTime(),t._preorder(),t._registerBackup(),t._initPoiCouponEvent(),t._reActiveSubmit(),$("#order-submit").click(function(){t.submit_order()}),$wm.store.getItem("wm_unlogin")?($wm.store.removeItem("wm_unlogin"),t._store.restore(),t._store.clear()):$wm.store.getItem("w_update")?($wm.store.removeItem("w_update"),t._store.restore(),t._store.clear()):$("#choose-pay").addClass("pay-"+(t._payType==1?"offline":"online"))}),window.bLog("waimai_i_order")},_reActiveSubmit:function(){var e=this;$("#user_address, #user_caution").on("focus keydown",function(){e.btn.reactive()})},_updateOrderData:function(e){var t=this,n=t._foodStore.poi,r=t._foodStore.orders;t._foodlist=[];for(var i in r){var o=i.split("-")[0],u=i.split("-")[1];t._foodlist.push({spu_id:o,id:u,count:r[i].num})}var a=arguments.callee;a.timer&&(clearTimeout(a.timer),a.timer=null),a.timer=setTimeout(function(){var r,i=$wm.store.getItem("currentAddr")?JSON.parse($wm.store.getItem("currentAddr")):null,o={wm_poi_id:n,foodlist:t._foodlist,caution:$("#user_caution").val().trim(),token:t._token,wm_order_pay_type:$wm.store.getItem("w_payType")?$wm.store.getItem("w_payType"):t._payType};$wm.store.getItem("w_preview")?r="preview":$wm.store.getItem("w_update")?r="update":t._inited?r="update":r="preview";if(r=="update"){if(i){var u={addr_id:i.id?i.id:"",recipient_name:i.name?i.name:"",recipient_gender:i.gender,recipient_phone:i.phone,recipient_address:i.address,house_number:i.house_number?i.house_number:"",addr_longitude:i.longitude,addr_latitude:i.latitude};o=$.extend(o,u)}o=$.extend(o,{poi_discount_coupon_id:$wm.store.getItem("poiDiscountCouponId")?$wm.store.getItem("poiDiscountCouponId"):0,expected_arrival_time:t._receiveTime&&t._receiveTime!="鏈€夋嫨"?t._receiveTime:0})}var f={data:JSON.stringify(o)},l=$('<div class="loading-mask"><div class="loading-block borderradius-2"><i class="loading-block-i"></i></div></div>');l.appendTo("body"),$.post(t.baseurl+"/order/ajax/"+r,f,function(r){l.remove(),t._inited=!0,$wm.store.removeItem("w_preview"),$wm.store.removeItem("w_editaddr");if(r.code==0&&r.data)t.orderData=r.data,t._token=t.orderData.token,$wm.store.setItem("poiDiscountCouponId",t.orderData.poi_discount_coupon_id),$wm.store.removeItem("w_payType"),t._isEmpty(t.orderData.address_info)||$wm.store.setItem("currentAddr",JSON.stringify(t.orderData.address_info)),t._refreshPage(),typeof e=="function"&&e();else if(r.code==1)new s({content:r.msg,mask:!0});else if(r.code==3&&r.data){var i=r.data,o=[];for(var u in i)o.push(i[u].name);new s({content:o.join()+"鑿滃搧缂哄け",mask:!0}),delayGo(t.baseurl+"/restaurant/"+n)}else r.msg&&(new s({content:r.msg,mask:!0}),delayGo(t.baseurl+"/restaurant/"+n))}),a.timer=null},20)},_refreshPage:function(){this._refreshFoodList(),this._refreshTotalPrice(),this._refreshPayType(),this._refreshWarning(),this._initAddress(),this._addrJump(),this._initPoiCoupon(),this._initActivity()},_initPoiCoupon:function(){var e=this,t=e.orderData;t.poi_discount_coupon_id>0?$("#poi-coupon-info").text(t.can_use_poi_coupon_info).data("couponid",t.poi_discount_coupon_id):$("#poi-coupon-info").text("鏃犲彲鐢ㄥ晢瀹朵唬閲戝埜").data("couponid",-1),$("#poi-coupon").show()},_initPoiCouponEvent:function(){var e=this,t=e.orderData;$("#poi-coupon-link").on("click",function(){var n={wm_poi_id:e._foodStore.poi,phone:t.address_info.phone,wm_order_pay_type:e._payType,total:t.total,original_price:t.original_price,can_use_coupon_price:t.can_use_coupon_price};$wm.store.setItem("w_payType",e._payType),$wm.store.setItem("w_cparas",JSON.stringify(n)),e._store.backup()})},_initActivity:function(){var e=this,t=e.orderData.discounts,n=t.length;if(!n)return $("#order-actv").hide(),!1;for(var r=0;r<n;r++)t[r].type==100&&($("#order-actv-list").empty().append('<li class="order-region-entry clearfix"><span class="order-actv-info">'+t[r].info+'</span> <span class="order-actv-name text-overflow-ellipsis-2">'+t[r].name+'</span><span class="order-actv-icon" style="background-image: url('+t[r].icon_url+')"></span></li>'),$("#order-actv").show())},_initAddress:function(){var e=this,t=e.orderData.address_type;addressInfo=e.orderData.address_info,t==0?$("#address-section").html('<a class="address-field address-choose j-address-add" href="javascript:"><i class="addr-add"></i><span>鏂板鏀惰揣鍦板潃</span></a>'):t==1?$("#address-section").html('<a class="address-field address-show j-address-recommend" href="javascript:"><p><span class="addr-name">'+addressInfo.name+'</span><span class="addr-gender">'+addressInfo.gender+'</span><span class="addr-phone">'+addressInfo.phone+'</span></p> <p class="addr-dtl">'+addressInfo.address+" "+addressInfo.house_number+"</p></a>"):$("#address-section").html('<a class="address-field address-choose j-address-chooose" href="javascript:"><i class="addr-add"></i><span>閫夋嫨鏀惰揣鍦板潃</span></a>')},_addrJump:function(){var e=this;$(".j-address-add").on("click",function(){return $wm.store.setItem("w_editaddr",!0),delayGo(e.baseurl+"/user/editaddr?type=1"),!1}),$(".j-address-recommend").on("click",function(){return delayGo(e.baseurl+"/user/getaddr?type=2&source=2&wm_poi_id="+e._foodStore.poi),!1}),$(".j-address-chooose").on("click",function(){return delayGo(e.baseurl+"/user/getaddr?type=2&source=2&wm_poi_id="+e._foodStore.poi),!1}),$(".address-field").on("click",function(){return $wm.store.setItem("w_payType",e._payType),e._store.backup(),!1})},_initPreTime:function(){var e=this,t=e.orderData;t.pre_order==1?($(".order-timefield-txt").text("鏈€夋嫨").data("unixtime",0),e._receiveTime="鏈€夋嫨"):($(".order-timefield-txt").text(t.expected_arrival_info.view_time).data("unixtime",t.expected_arrival_info.unixtime),e._receiveTime=t.expected_arrival_info.unixtime),t.pre_order==0&&!t.expected_arrival_info.clickable?(e._supportAssignDeliveryTime=!1,$("#order-timefield").addClass("order-timefield-unclick")):e._supportAssignDeliveryTime=!0,$("#order-timefield").show()},_refreshFoodList:function(){var e=this.orderData,t=self._foodlist=e.foodlist,n=$("#template-food-item").html(),r=[];for(var i=0,s=t.length;i<s;i++){var o=t[i];r.push(u(n,{name:o.name,num:o.count,price:+o.price.toFixed(2),icon:o.food_label_url,totalPrice:+(o.price*o.count).toFixed(2)}))}r.push(u(n,{name:"閰嶉€佽垂",sendPrice:e.shipping_fee})),e.box_total_price>0&&r.push(u(n,{name:"椁愮洅璐�",boxPrice:+e.box_total_price.toFixed(2)})),$("#food-items").html(r.join(""))},_refreshDiscounts:function(){var e=this.orderData,t='<li class="order-region-entry"><span><%=name%></span><span class="fr"><%=info%></span></li>',n=[];if(e.discounts)for(var r=0,i=e.discounts.length;r<i;r++){var s=e.discounts[r];n.push(u(t,{name:s.name,info:s.info}))}n.length>0?($("#order-favor-list").html(n.join("")),$("#order-favor-wrap").show()):($("#order-favor-list").empty(),$("#order-favor-wrap").hide())},_refreshTotalPrice:function(){var e=this.orderData;$("#order-total").text("锟�"+ +e.total.toFixed(2))},_refreshWarning:function(){var e=this.orderData;e.discount_mutex_info?a.show(e.discount_mutex_info):a.hide(),e.app_delivery_tip&&$("#delivery-tip").html(e.app_delivery_tip)},_refreshPayType:function(){this._payType=this.orderData.default_pay_type},_refreshPayTip:function(){var e=$("#order-paytype-2").find(".j-order-payonline-discount"),t=this.orderData.payment_info.payment_tip;t!=null?e.text(t).show():e.text("").hide()},_forbid:function(e){var n=new t({content:e,btns:[{value:"鏌ョ湅鏈嶅姟鏉℃",func:function(){delayGo("http://i.waimai.meituan.com/static/html/faq.html?terminal=mtapp"),n.close()}},{value:"鏆備笉鏌ョ湅",func:function(){n.close()}}]})},_reorder:function(e){var n=this,r=new t({content:"鎶辨瓑锛屾偍鐐圭殑鑿滃搧搴撳瓨涓嶈冻锛岃鎮ㄩ噸鏂扮偣椁�",btns:[{value:"鐭ラ亾浜�",func:function(){r.close(),delayGo(n.baseurl+"/restaurant/"+n._foodStore.poi)}}]})},_shopUnavailable:function(e){var n=this,r=e==18?"鎶辨瓑锛岃鍟嗗宸蹭笅绾匡紝鍘荤湅鐪嬪埆鐨勫晢瀹跺惂":"鎶辨瓑锛屽晢瀹跺凡缁忎紤鎭簡锛屽幓鐪嬬湅鍒殑鍟嗗鍚�",i=new t({content:r,btns:[{value:"杩斿洖棣栭〉",func:function(){delayGo(n.baseurl+"/home")}}]})},_preorder:function(){var e=$("#user_receive_time"),t=this;if(!t._supportAssignDeliveryTime)return!1;e.on("click",function(){var e=[];e.push('<h4 class="receive_time_title">璇烽€夋嫨閫佽揪鏃堕棿</h4>'),e.push('<div id="receive_time_wrap">'),e.push("<div>"),e.push('<ul class="receive_time_list">'),$.get(t.baseurl+"/order/ajax/getarrivaltime",{wm_poi_id:t._foodStore.poi},function(n){if(!n.code&&n.data){var r=n.data.expected_arrival_timelist,i=r[0].timelist;for(var s=0,o=i.length;s<o;s++)e.push("<li"+(s?"":' class="hvr"')+' data-selected="'+i[s].select_view_time+'" data-unixtime="'+i[s].unixtime+'">'+i[s].view_time+"</li>");e.push("</ul>"),e.push("</div>"),e.push("</div>"),$("html, body").css("overflow","hidden");var u=new f({id:"receive_time_dialog",content:e.join(""),show:!1});$("#receive_time_dialog").css("max-height",$(window).height()*.9),u.show();var a=new IScroll("#receive_time_wrap",{tap:!0});$(".receive_time_list").on("tap","li",function(){var e=$(this),n=e.data("selected"),r=e.data("unixtime");$("html, body").css("overflow","visible"),u.close(),$(".order-timefield-txt").text(n).data("unixtime",r),t._receiveTime=r,t._updateOrderData()}),$(".mask").on("click",function(){$("html, body").css("overflow","visible"),u.close()})}})});var n=e.find(".order-timefield-txt");t._store.register({name:"receiveTime",backup:function(){return n.text()+";"+n.data("unixtime")},restore:function(e){t._receiveTime=e.split(";")[1],n.text(e.split(";")[0])}})},_registerBackup:function(){var e=this;e._store.register({name:"payType",backup:function(){return e._payType},restore:function(t){e._payType=t,$("#choose-pay").addClass("pay-"+(t==1?"offline":"online"))}}),e._store.register({name:"user_caution",backup:function(){return $("#user_caution").val()},restore:function(e){$("#user_caution").val(e)}})},_initPayType:function(){var e=this,t=e.orderData.payment_info,n=t.length,r=$("#choose-pay");for(var i=0;i<n;i++){var s=t[i];s.display_switch==1&&$("#order-paytype-"+s.payment_type).show()}$("#choose-pay-wrap").show(),n>1&&($("#order-paytype-2").click(function(){e._payType!=2&&(e.btn.reactive(),e._payType=2,r.removeClass("pay-offline").addClass("pay-online"),e._updateOrderData())}),$("#order-paytype-1").click(function(){e._payType!=1&&(e.btn.reactive(),e._payType=1,r.removeClass("pay-online").addClass("pay-offline"),e._updateOrderData())}))},_initShowRule:function(){var e=null,t=null,n=function(){e==null&&(e=new o({content:'<div class="order-showrule-dialog">'+t+"</div>",show:!1,hideOnClose:!0})),e._$wrapper.find("#header").addClass("rule-dlg-header"),e.show()};$("#order-tips-showrule").click(function(){t==null?$.get("/static/html/faq-salerule.html",function(e){var r=e.match(/<body>([\s\S]+)<\/body>/);r&&r[1]&&(t=r[1]),n()}):n()})},_clear:function(){this._store.clear(),$wm.store.removeItem("v_order_hash")},_isEmpty:function(e){for(var t in e)return!1;return!0}}});